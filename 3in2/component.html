<div {...attrs} ref:target />

<script>
export default {
    data : () => ({
        // svelte3 component to invoke
        component : false,

        // props for svelte3 component
        props : false,

        // Attributes to apply to the placeholder <div> this component has to create
        attrs : false,
    }),

    methods : {
        instantiate() {
            const { component, attrs, ...props } = this.get();
            const { target } = this.refs;

            // Cleanup any previous component instance first
            if(this.instance) {
                this.cleanup();
            }

            if(!component || typeof component !== "function") {
                throw new Error("Invalid svelte3 component passed to wrapper");
            }

            this.instance = new component({
                target,
                props,
            });
        },

        cleanup() {
            if(!this.instance) {
                return;
            }

            this.instance.$destroy();
            this.instance = null;
        },
    },

    oncreate() {
        const { component } = this.get();

        if(component) {
            this.instantiate();
        }    

        this.on("state", ({ changed, current }) => {
            if(changed.component) {
                return this.instantiate();
            }
            
            if(this.instance) {
                const { component, attrs, ...props } = current;

                return this.instance.$set(props);
            }
        });
    },

    ondestroy() {
        this.cleanup();
    },
};
</script>
